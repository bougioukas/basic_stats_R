# Receiver Operating Characteristic (ROC) curve {#sec-roc}

When a diagnostic test result is measured in a **continuous scale**, sensitivity and specificity vary with different cut-off points (thresholds). Therefore, a **convenient** cut-off point^[**NOTE:** there is critique, however, that the binary diagnosis is problematic.] must be selected in order to calculate the measures of diagnostic accuracy of the test. **Receiver operating characteristic** (ROC) curve analysis can be used to help with this decision.

When we have finished this Chapter, we should be able to:

::: {.callout-caution icon="false"}
## Learning objectives

-   Evaluate a diagnostic test
-   Compare different diagnostic tests
-   Interpret the results
:::

## Research question

We want to compare two screening questionnaires for chronic obstructive pulmonary disease (COPD) among smokers aged \>45 years in the primary care setting:

-   *International Primary Care Airways Group (IPAG)* questionnaire
-   *COPD Population Screener (COPDPS)* questionnaire

The diagnosis of COPD was based on spirometric criterion (FEV 1 /FVC \<0.7 following bronchodilation), clinical status (medical history, symptoms and physical examination), and exclusion of other diseases.


## Packages we need

We need to load the following packages:

```{r}
#| message: false
#| warning: false

library(pROC)
library(OptimalCutpoints)
library(plotROC)
library(rstatix)
library(ggsci)
library(here)
library(tidyverse)
```

## Preraring the data

We import the data *copd* in R:

```{r}
#| warning: false

library(readxl)
dat <- read_excel(here("data", "copd.xlsx"))
dat <- as.data.frame(dat)

# we need to create a roc object for each questionnaire
roc1 <- roc(dat$diagnosis, dat$IPAG)
roc2 <- roc(dat$diagnosis, dat$COPDPS)
```

```{r}
#| echo: false
#| label: fig-depression
#| fig-cap: Table with data from "depression" file.

DT::datatable(
  dat, extensions = 'Buttons', options = list(
    dom = 'tip',
    columnDefs = list(list(className = 'dt-center', targets = "_all"))
  )
)

```

We inspect the data and the type of variables:

```{r}
glimpse(dat)
```

## Accuracy measures

The **Youden index** (*J* statistic) is often used to find the optimal cut-off point for sensitivity and specificity. It is defined as the sum of sensitivity and specificity minus 1:

$$ J = Se + Sp - 1$$
The range of J is $(-1, 1)$. Higher values of *J* indicate higher diagnostic validity. 
A value of 1 indicates that there are no false positives or false negatives, i.e. the test is perfect because both sensitivity and specificity equal to 1. A value of 0 indicates that the test has no diagnostic value. 

Thus, the **maximum** value of the *Youden index, J,* may be used as a criterion for selecting the optimum cut-off point when the diagnostic test result is measured in a continuous scale:

$$ J_{max} = max\{Se_{cutoff} + Sp_{cutoff} - 1\}$$

::: callout-important

For screening purposes such as mammogram, the cut-off point can be selected to favor a higher sensitivity. Thus, a negative test result indicates the absent of the disease (SeNout; sensitive, negative, "rule out" the disease).

For confirmative diagnosis purposes, for example, when a chemotherapy is to initiated once the diagnosis is established, the cut-off point can be selected to favor a higher specificity. Thus, a positive test result indicates the presence of disease (SpPin; specificity, positive, "rule in" the disease).
:::

 

**A. IPAG questionnaire**

::: callout-tip
## Optimal cut-point based on Youden Index: IPAG questionnaire

::: panel-tabset
## OptimalCutpoints

```{r}

IPAG_Youden <- optimal.cutpoints(X = "IPAG", status = "diagnosis",
                                 tag.healthy = 0, 
                                 methods = c("Youden"), 
                                 data = dat)

summary_IPAG_Youden <- summary(IPAG_Youden)
summary_IPAG_Youden

```

## pROC

```{r}
#| warning: false

coords(roc1, "best", ret = c("threshold", "sensitivity", 
                             "specificity", "ppv", "npv", 
                             "accuracy"), best.method="youden")
```
:::
:::

The results using the optimal criterion based on Youden's Index, $J_{max} = 0.48$, give Se = 0.674 and Sp = 0.806. We can extract the sensitivity and specificity of IPAG questionnaire from the above summary results as folows:

::: column-margin
$$ J_{max} = 0.674 + 0.806 - 1 =  1.48 - 1 = 0.48$$
:::


```{r}
# extract the sensitivity
se_IPAG_Youden <- summary_IPAG_Youden$Youden$Global$optimal.cutoff$Se
se_IPAG_Youden[1,1]

# extract the specificity
sp_IPAG_Youden <- summary_IPAG_Youden$Youden$Global$optimal.cutoff$Sp
sp_IPAG_Youden[1,1]

```

 

**B. COPDPS questionnaire**

::: callout-tip
## Optimal cut-point based on Youden Index: COPDPS questionnaire

::: panel-tabset
## OptimalCutpoints

```{r}

COPDPS_Youden <- optimal.cutpoints(X = "COPDPS", status = "diagnosis",
                                 tag.healthy = 0, 
                                 methods = c("Youden"), 
                                 data = dat)

summary_COPDPS_Youden <- summary(COPDPS_Youden)
summary_COPDPS_Youden
```

## pROC

```{r}
#| warning: false

coords(roc2, "best", ret = c("threshold", "sensitivity", 
                             "specificity", "ppv", "npv", 
                             "accuracy"), best.method="youden")
```
:::
:::

Similarly, we can extract the values of sensitivity and specificity from the accuracy measures table of COPDPS as follows:

```{r}

# extract the sensitivity
se_COPDPS_Youden <- summary_COPDPS_Youden$Youden$Global$optimal.cutoff$Se
se_COPDPS_Youden[1,1]

# extract the specificity
sp_COPDPS_Youden <- summary_COPDPS_Youden$Youden$Global$optimal.cutoff$Sp
sp_COPDPS_Youden[1,1]
```

## ROC curve

We can plot the sensitivity on the y-axis and 1-specificity (false positives) values on the x-axis for all possible cut-off points of the diagnostic test (@fig-roc1 and @fig-roc2). The area under the ROC curve (AUC of ROC), also called the c-statistic, is a widely used measure of overall performance.  


**A. IPAG questionnaire**

First, let's calculate the AUC (95% CI) of ROC for the IPAG questionnaire (@fig-roc1): 

```{r}
#| warning: false

# get AUC IPAG and the 95%CI for this area
auc_values1 <- round(ci.auc(roc1), 3)
auc_values1
```


```{r}
#| warning: false
#| label: fig-roc1
#| fig-width: 7
#| fig-cap: The ROC curve of IPAG questionnaire.

# extract the lower value of 95%CI, AUC, and upper value of 95%CI
ci_l1 <- auc_values1[1]
auc1 <- auc_values1[2]
ci_u1 <- auc_values1[3]


# create the plot
g <- ggplot(dat, aes(d = diagnosis, m = IPAG)) + 
  geom_roc(n.cuts = 0, color = "#0071BF") +
  theme(text = element_text(size = 14)) +
  geom_abline(intercept = 0, slope = 1, linetype = 'dashed') +
  geom_point(aes(x = 1-sp_IPAG_Youden, y = se_IPAG_Youden), color = "black") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = "1 - Specificity", y = "Sensitivity")

# add annotations to the plot
g + annotate("text", x=0.70, y=0.30, 
           label=paste("AUC IPAG = ", auc1, 
                       " (95% CI = ", ci_l1, " - ", ci_u1, ")")) +
  annotate("text", x=0.09, y=0.69, 
           label=paste("Se =", round(se_IPAG_Youden, 3))) +
  annotate("text", x=0.09, y=0.66, 
           label=paste("1-Sp =", 1-round(sp_IPAG_Youden, 3)))
```

The AUC of IPAG ROC equals to 0.799 (95% CI: 0.769 - 0.829) which indicates a reasonable diagnostic test. Obviously, a test which is perfect at discriminating between those with disease and those without disease has an AUC = 1. 

The dashed diagonal line connecting (0,0) to (1,1) is the ROC curve corresponding to a test that is completely useless in diagnosis of a disease, AUC = 0.5 (i.e. individuals with and without the disease have equal “chances” of testing positive).

 

**B. COPDPS questionnaire**

Next, let's calculate the AUC (95% CI) of ROC for the COPDPS questionnaire (@fig-roc2): 
```{r}
#| warning: false

# get AUC COPDPS and the 95%CI for this area
auc_values2 <- round(ci.auc(roc2), 3)
auc_values2
```


```{r}
#| warning: false
#| label: fig-roc2
#| fig-width: 7
#| fig-cap: The ROC curve of COPDPS questionnaire.

# extract the lower value of 95%CI, AUC, and upper value of 95%CI
ci_l2 <- auc_values2[1]
auc2 <- auc_values2[2]
ci_u2 <- auc_values2[3]


# create the plot
g <- ggplot(dat, aes(d = diagnosis, m = COPDPS)) + 
  geom_roc(n.cuts = 0, color = "#EFC000") +
  theme(text = element_text(size = 14)) +
  geom_abline(intercept = 0, slope = 1, linetype = 'dashed') +
  geom_point(aes(x = 1-sp_COPDPS_Youden, y = se_COPDPS_Youden), color = "black") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = "1 - Specificity", y = "Sensitivity")

# add annotations to the plot
g + annotate("text", x=0.70, y=0.25, 
           label= paste("AUC COPDPS = ", auc2, 
                        " (95% CI = ", ci_l2, " - ", ci_u2, ")")) +
  annotate("text", x=0.19, y=0.58, 
           label=paste("Se =", round(se_COPDPS_Youden, 3))) +
  annotate("text", x=0.19, y=0.54, 
           label=paste("1-Sp =", 1-round(sp_COPDPS_Youden, 3)))

```

The AUC of COPDPS ROC equals to 0.791 (95% CI: 0.760 - 0.821) which is close to the value of AUC of IPAG ROC.



## Compare ROC Curves

### Graphically comparison with ROC curves

```{r}
#| warning: false
#| label: fig-rocs
#| fig-width: 7
#| fig-cap: Comparison between IPAG and COPDPS ROC curves.

# prepare the data
longdata <- melt_roc(dat, "diagnosis", c("IPAG", "COPDPS"))

longdata$name = factor(longdata$name, levels = c("IPAG", "COPDPS"))

# create the plot
g <- ggplot(longdata, aes(d = D, m = M, color = name)) + 
  geom_roc(n.cuts = 0) +
  theme(text = element_text(size = 14),
        legend.position="top") +
  geom_abline(intercept = 0, slope = 1, linetype = 'dashed') +
  geom_point(aes(x = 1-sp_IPAG_Youden, y = se_IPAG_Youden), color = "black") +
  geom_point(aes(x = 1-sp_COPDPS_Youden, y = se_COPDPS_Youden), colour = "black") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_color_jco() +
  labs(x = "1 - Specificity", y = "Sensitivity", colour="Questionnaire")

# add annotations to the plot
g + annotate("text", x=0.70, y=0.35, 
           label=paste("AUC IPAG = ", auc1, 
                       " (95% CI = ", ci_l1, " - ", ci_u1, ")")) +
  annotate("text", x=0.70, y=0.25, 
           label= paste("AUC COPDPS = ", auc2, 
                        " (95% CI = ", ci_l2, " - ", ci_u2, ")")) +
  annotate("text", x=0.09, y=0.69, 
           label=paste("Se =", round(se_IPAG_Youden, 3))) +
  annotate("text", x=0.09, y=0.66, 
           label=paste("1-Sp =", 1-round(sp_IPAG_Youden, 3))) +
  annotate("text", x=0.19, y=0.58, 
           label=paste("Se =", round(se_COPDPS_Youden, 3))) +
  annotate("text", x=0.19, y=0.54, 
           label=paste("1-Sp =", 1-round(sp_COPDPS_Youden, 3)))
```

### Compare AUCs: DeLong' s test

The DeLong's test can be used for comparing 2 areas under the curve (AUCs).


::: {.callout-note icon="false"}
## Null hypothesis and alternative hypothesis

-   $H_0$: there is no difference between two AUCs
-   $H_1$: there is difference between two AUCs
:::

```{r}
#| warning: false

roc.test(roc1, roc2, method=c("delong"))

```


